FROM oven/bun:1 AS builder

WORKDIR /build

# Install git and clone oh-my-opencode (required for build script)
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN git clone --depth 1 https://github.com/code-yeongyu/oh-my-opencode.git /tmp/oh-my-opencode
ENV OMO_PATH=/tmp/oh-my-opencode

# Copy source and build
COPY package.json bun.lock* ./
COPY scripts ./scripts
RUN bun install --frozen-lockfile

COPY . .
RUN bun run build

# Final image
FROM debian:trixie-slim

# Install OpenCode and curl (for healthcheck)
RUN apt-get update && apt-get install -y curl ca-certificates && rm -rf /var/lib/apt/lists/*
RUN curl -fsSL https://github.com/opencode-ai/opencode/releases/latest/download/opencode-linux-x86_64.tar.gz -o /tmp/opencode.tar.gz && \
    tar -xzf /tmp/opencode.tar.gz -C /usr/local/bin && \
    chmod +x /usr/local/bin/opencode && \
    rm /tmp/opencode.tar.gz

# Install plugin from builder
COPY --from=builder /build/dist /root/.local/share/opencode/plugins/opencode-aicodewith-auth/dist
COPY --from=builder /build/assets /root/.local/share/opencode/plugins/opencode-aicodewith-auth/assets
COPY --from=builder /build/package.json /root/.local/share/opencode/plugins/opencode-aicodewith-auth/

WORKDIR /workspace

CMD ["opencode", "serve", "--port=4096", "--hostname=0.0.0.0"]
