services:
  e2e:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: e2e

  # OpenCode HTTP server for smoke tests
  opencode-server:
    build:
      context: .
      dockerfile: Dockerfile.opencode
    command: ["opencode", "serve", "--port=4096", "--hostname=0.0.0.0"]
    ports:
      - "4096:4096"
    environment:
      - OPENCODE_CONFIG=/workspace/opencode-config.json
    configs:
      - source: opencode_config
        target: /workspace/opencode-config.json
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4096/health"]
      interval: 2s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - test-network

  smoke:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: smoke
    environment:
      - AICODEWITH_API_KEY=${AICODEWITH_API_KEY}
      - OPENCODE_SERVER_URL=http://opencode-server:4096
    depends_on:
      opencode-server:
        condition: service_healthy
    networks:
      - test-network

  smoke-agents:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: smoke
    environment:
      - AICODEWITH_API_KEY=${AICODEWITH_API_KEY}
      - OPENCODE_SERVER_URL=http://opencode-server:4096
    depends_on:
      opencode-server:
        condition: service_healthy
    networks:
      - test-network
    command: ["bun", "tests/docker/smoke-test-agents.ts"]

networks:
  test-network:
    driver: bridge

configs:
  opencode_config:
    content: |
      {
        "$schema": "https://opencode.ai/config.json",
        "plugin": ["opencode-aicodewith-auth"]
      }
