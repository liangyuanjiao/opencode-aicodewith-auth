FROM oven/bun:1 AS base
WORKDIR /app

FROM base AS deps
COPY package.json bun.lock* ./
COPY scripts ./scripts
RUN bun install --frozen-lockfile

FROM base AS e2e
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN git clone --depth 1 https://github.com/code-yeongyu/oh-my-opencode.git /tmp/oh-my-opencode
ENV OMO_PATH=/tmp/oh-my-opencode

COPY --from=deps /app/node_modules ./node_modules
COPY . .
CMD ["bun", "tests/docker/e2e-test.ts"]

FROM base AS smoke
# Install OpenCode CLI from official release (required by createOpencodeServer)
RUN apt-get update && apt-get install -y git curl && rm -rf /var/lib/apt/lists/*
RUN curl -fsSL https://github.com/opencode-ai/opencode/releases/latest/download/opencode-linux-amd64.deb -o /tmp/opencode.deb && \
    dpkg -i /tmp/opencode.deb && \
    rm /tmp/opencode.deb
RUN opencode --version

# Clone oh-my-opencode for build script
RUN git clone --depth 1 https://github.com/code-yeongyu/oh-my-opencode.git /tmp/oh-my-opencode
ENV OMO_PATH=/tmp/oh-my-opencode

COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN bun run build
CMD ["bun", "tests/docker/smoke-test.ts"]
