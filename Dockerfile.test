FROM oven/bun:1 AS base
WORKDIR /app

FROM base AS deps
COPY package.json bun.lock* ./
COPY scripts ./scripts
RUN bun install --frozen-lockfile

FROM base AS e2e
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN git clone --depth 1 https://github.com/code-yeongyu/oh-my-opencode.git /tmp/oh-my-opencode
ENV OMO_PATH=/tmp/oh-my-opencode

COPY --from=deps /app/node_modules ./node_modules
COPY . .
CMD ["bun", "tests/docker/e2e-test.ts"]

FROM base AS smoke-builder
WORKDIR /app

# Copy oh-my-opencode from e2e stage (avoid re-cloning)
COPY --from=e2e /tmp/oh-my-opencode /tmp/oh-my-opencode
ENV OMO_PATH=/tmp/oh-my-opencode

# Install OpenCode via npm (bun has issues with optionalDependencies)
RUN apt-get update && apt-get install -y nodejs npm && rm -rf /var/lib/apt/lists/* && \
    npm install -g opencode-ai@latest

# Build plugin
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN bun run build

FROM base AS smoke
WORKDIR /app

# Install OpenCode via npm
RUN apt-get update && apt-get install -y nodejs npm && rm -rf /var/lib/apt/lists/* && \
    npm install -g opencode-ai@latest

# Copy built plugin and oh-my-opencode from builder
COPY --from=smoke-builder /tmp/oh-my-opencode /tmp/oh-my-opencode
COPY --from=smoke-builder /app/dist ./dist
COPY --from=smoke-builder /app/assets ./assets
COPY --from=smoke-builder /app/package.json ./package.json
COPY --from=deps /app/node_modules ./node_modules
COPY lib ./lib
COPY tests ./tests

ENV OMO_PATH=/tmp/oh-my-opencode

# Install plugin to OpenCode
RUN mkdir -p /root/.local/share/opencode/plugins/opencode-aicodewith-auth && \
    cp -r dist /root/.local/share/opencode/plugins/opencode-aicodewith-auth/ && \
    cp -r assets /root/.local/share/opencode/plugins/opencode-aicodewith-auth/ && \
    cp package.json /root/.local/share/opencode/plugins/opencode-aicodewith-auth/

# Run smoke test (SDK starts its own server)
CMD ["bun", "tests/docker/smoke-test.ts"]
